//
//  TapInFeatureTests.swift
//  TapInTests
//

import XCTest
@testable import TapIn

final class TapInFeatureTests: XCTestCase {

    // MARK: - Sample Data
    let sampleItem1 = MenuItem(name: "Burger", price: 9.99)
    let sampleItem2 = MenuItem(name: "Fries", price: 3.49)

    func makeTable(items: [MenuItem] = [], guests: Int = 0) -> TableInfo {
        return TableInfo(
            tableNumber: "T1",
            guests: guests,
            items: items
        )
    }
    
    // MARK: 1. Valid Login (logic level)
    func testValidLogin() {
        let validPins = ["1234", "2222", "9001"]
        let entered = "1234"
        XCTAssertTrue(validPins.contains(entered))
    }

    // MARK: 2. Invalid Login
    func testInvalidLogin() {
        let validPins = ["1234", "2222"]
        let entered = "5555"
        XCTAssertFalse(validPins.contains(entered))
    }

    // MARK: 3. PIN Delete
    func testPinDelete() {
        var pin = "123"
        pin.removeLast()
        XCTAssertEqual(pin, "12")
    }

    // MARK: 4. Tap Table Opens Data
    func testTableLoadsGuests() {
        let table = makeTable(guests: 4)
        XCTAssertEqual(table.guests, 4)
    }

    // MARK: 5. Side Panel Close (state test)
    func testSidePanelClose() {
        var isOpen = true
        isOpen = false
        XCTAssertFalse(isOpen)
    }

    // MARK: 6. Load Items From Firestore (mock)
    func testTableLoadsItems() {
        let table = makeTable(items: [sampleItem1, sampleItem2])
        XCTAssertEqual(table.items.count, 2)
    }

    // MARK: 7. Empty Table State
    func testEmptyTableShowsZeroSubtotal() {
        let table = makeTable(items: [])
        XCTAssertEqual(table.items.count, 0)
    }

    // MARK: 8. Increase Guests
    func testIncreaseGuests() {
        var t = makeTable(guests: 2)
        t = TableInfo(tableNumber: t.tableNumber, guests: t.guests + 1, items: t.items)
        XCTAssertEqual(t.guests, 3)
    }

    // MARK: 9. Decrease Guests
    func testDecreaseGuests() {
        var t = makeTable(guests: 2)
        t = TableInfo(tableNumber: t.tableNumber, guests: max(0, t.guests - 1), items: t.items)
        XCTAssertEqual(t.guests, 1)
    }

    // MARK: 10. Add Items Navigation (mock)
    func testAddItemsNavigation() {
        var didNavigate = false
        didNavigate = true
        XCTAssertTrue(didNavigate)
    }

    // MARK: 11. Menu Items Load (mock)
    func testMenuItemsLoad() {
        let menu = [sampleItem1, sampleItem2]
        XCTAssertEqual(menu.count, 2)
    }

    // MARK: 12. Search Filter
    func testSearchFilter() {
        let menu = ["Burger", "Fries", "Tacos"]
        let filtered = menu.filter { $0.lowercased().contains("bur") }
        XCTAssertEqual(filtered, ["Burger"])
    }

    // MARK: 13. Clear Search
    func testClearSearch() {
        let menu = ["Burger", "Fries"]
        let search = ""
        let filtered = menu.filter { search.isEmpty || $0.contains(search) }
        XCTAssertEqual(filtered.count, 2)
    }

    // MARK: 14. Add Item to Table
    func testAddItemToTable() {
        var table = makeTable(items: [])
        let updated = TableInfo(
            tableNumber: table.tableNumber,
            guests: table.guests,
            items: table.items + [sampleItem1]
        )
        XCTAssertEqual(updated.items.count, 1)
    }

    // MARK: 15. Remove Item From Table
    func testRemoveItemFromTable() {
        let table = makeTable(items: [sampleItem1])
        let filtered = table.items.filter { $0.name != sampleItem1.name }
        XCTAssertEqual(filtered.count, 0)
    }

    // MARK: 16. Remove Last Item
    func testRemoveLastItem() {
        let table = makeTable(items: [sampleItem1])
        XCTAssertEqual(table.items.count, 1)
        let updated = table.items.filter { $0.name != sampleItem1.name }
        XCTAssertEqual(updated.count, 0)
    }

    // MARK: 17. Subtotal
    func testSubtotalCalculation() {
        let items = [sampleItem1, sampleItem2]  // 9.99 + 3.49 = 13.48
        let subtotal = items.reduce(0) { $0 + $1.price }
        XCTAssertEqual(subtotal, 13.48, accuracy: 0.001)
    }

    // MARK: 18. Tax
    func testTaxCalculation() {
        let subtotal = 10.00
        let tax = subtotal * 0.148
        XCTAssertEqual(tax, 1.48, accuracy: 0.0001)
    }

    // MARK: 19. Pay Amount
    func testPayAmount() {
        let subtotal = 10.0
        let tax = 1.48
        let total = subtotal + tax
        XCTAssertEqual(total, 11.48, accuracy: 0.001)
    }

    // MARK: 20. Back Navigation
    func testBackNavigationFlag() {
        var didGoBack = false
        didGoBack = true
        XCTAssertTrue(didGoBack)
    }
}
